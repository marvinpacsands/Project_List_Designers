<script>
/**
 * GasClient.html
 * Shared GAS bridge (Promise wrapper around google.script.run).
 * Safe to include even if a file already defined gasCall — it won’t overwrite.
 */
(function () {
  if (window.gasCall) return; // do not override if already present

  function gasIsAvailable() {
    return !!(window.google && google.script && google.script.run);
  }

  function normalizeGasError(err) {
    if (!err) return new Error('Unknown Apps Script error');
    if (err instanceof Error) return err;
    const msg =
      (typeof err === 'string' && err) ||
      (err && err.message) ||
      (err && err.details) ||
      JSON.stringify(err);
    return new Error(msg);
  }

  window.gasIsAvailable = gasIsAvailable;

  window.gasCall = function (fnName, arg) {
    return new Promise((resolve, reject) => {
      try {
        if (!gasIsAvailable()) return reject(new Error('google.script.run not available'));

        const runner = google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler((err) => reject(normalizeGasError(err)));

        if (arg === undefined) runner[fnName]();
        else runner[fnName](arg);
      } catch (e) {
        reject(e);
      }
    });
  };
})();
</script>
