<script>
function ensureLegacyProjectShape_(p) {
  if (!p) return p;

  // Add legacy flat fields expected by some PM/Ops helpers (designer1/2/3, priority1/2/3, notes1/2/3)
  if (!('designer1' in p) && Array.isArray(p.team)) {
    const t = (slot) => (p.team.find(x => Number(x.slot) === Number(slot)) || {});
    const t1 = t(1), t2 = t(2), t3 = t(3);

    p.designer1 = t1.name || '';
    p.designer2 = t2.name || '';
    p.designer3 = t3.name || '';

    p.priority1 = t1.priority || '';
    p.priority2 = t2.priority || '';
    p.priority3 = t3.priority || '';

    p.notes1 = t1.notes || '';
    p.notes2 = t2.notes || '';
    p.notes3 = t3.notes || '';
  }

  return p;
}

function ensureLegacyProjects_(arr) {
  return (arr || []).map(ensureLegacyProjectShape_);
}

function apiProjectsRequest_(params) {
  // Apps Script mode
  if (window.google && google.script && google.script.run && typeof gasCall === 'function') {
    return gasCall('apiProjects', params);
  }

  // Local/Express fallback
  const q = new URLSearchParams();
  q.set('mode', params.mode || '');
  q.set('email', params.email || '');
  if (params.pmName !== undefined) q.set('pmName', params.pmName);
  if (params.includeUnassigned !== undefined) q.set('includeUnassigned', params.includeUnassigned);
  q.set('_t', Date.now());
  return fetch('/api/projects?' + q.toString()).then(r => r.json());
}

function loadOperational() {
  document.getElementById('liveText').textContent = 'Syncing Ops...';

  apiProjectsRequest_({ mode: 'ops', email: window.currentUser.email })
    .then(res => {
      const next = ensureLegacyProjects_(res.projects || []);
      if (window.Notif && typeof Notif.onOpsUpdate === 'function') try { Notif.onOpsUpdate(OPS_ROWS, next); } catch (e) { }
      OPS_ROWS = next;
      if (res.people) PEOPLE_LIST = res.people;
      document.getElementById('liveText').textContent = 'Live';
      if (ACTIVE_TAB === 'ops') render();
    })
    .catch(err => {
      console.error(err);
      document.getElementById('liveText').textContent = 'Error';
    });
}

    document.getElementById('liveText').textContent = 'Syncing Ops...';
    fetch('/api/projects?mode=ops&email=' + encodeURIComponent(window.currentUser.email))
        .then(r => r.json())
        .then(res => {
            const next = res.projects || [];
            if (window.Notif && typeof Notif.onOpsUpdate === 'function') try { Notif.onOpsUpdate(OPS_ROWS, next); } catch (e) { }
            OPS_ROWS = next;
            if (res.people) PEOPLE_LIST = res.people;
            document.getElementById('liveText').textContent = 'Live';
            if (ACTIVE_TAB === 'ops') render();
        });
}

function buildOperationalCard(r) {
    const card = document.createElement('div');
    card.className = `card`;
    card.style.borderLeftColor = '#8b5cf6'; // Ops purple
    card.id = `card-${r.rowIndex}`;

    // 1. Header (Project Info)
    const top = document.createElement('div');
    top.className = 'card-top';

    const left = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'project-title';
    title.innerHTML = r.internalId
        ? `<a href="https://app.contractorforeman.net/manage-projects/${encodeURIComponent(r.internalId)}" target="_blank">${r.projectName || 'Untitled'}</a>`
        : (r.projectName || 'Untitled');

    const meta = document.createElement('div');
    meta.className = 'project-meta';
    meta.innerHTML = `<span>#${r.projectNumber}</span> <span class="pm-tag">${r.pmName || 'Unassigned'}</span>`;

    left.appendChild(title);
    left.appendChild(meta);
    top.appendChild(left);
    top.appendChild(buildStatusBadge(r.status));
    card.appendChild(top);

    // 2. Card Body
    const body = document.createElement('div');
    body.className = 'card-body';

    // --- PM Section (Grid Layout) ---
    const pmSection = document.createElement('div');
    pmSection.style.display = 'grid';
    pmSection.style.gridTemplateColumns = 'repeat(3, 1fr)';
    pmSection.style.gap = '12px';
    pmSection.style.marginBottom = '16px';

    // Col 1: Assign PM
    const col1 = document.createElement('div');
    col1.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);display:block;margin-bottom:4px;">ASSIGN PM</label>';

    const pmWrapper = document.createElement('div');
    pmWrapper.className = 'custom-multiselect';
    pmWrapper.dataset.row = r.rowIndex;

    const currentPMs = (r.pmName || '').split(',').map(s => s.trim()).filter(Boolean);
    const isSelected = currentPMs.length > 0;

    const trigger = document.createElement('div');
    trigger.className = 'select-trigger';
    trigger.textContent = isSelected ? currentPMs.join(', ') : 'Select PM...';
    trigger.onclick = (e) => {
        e.stopPropagation();
        const opts = pmWrapper.querySelector('.select-options');
        document.querySelectorAll('.select-options').forEach(el => {
            if (el !== opts) el.classList.add('hidden');
        });
        opts.classList.toggle('hidden');
    };

    const optsDiv = document.createElement('div');
    optsDiv.className = 'select-options hidden';

    // PM Options
    const pms = PEOPLE_LIST.filter(p => (p.role || '').toUpperCase().includes('PM'));
    pms.forEach(p => {
        const label = document.createElement('label');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = p.name;
        chk.checked = currentPMs.some(c => normalize(c) === normalize(p.name));

        chk.onchange = () => {
            const checked = Array.from(optsDiv.querySelectorAll('input:checked')).map(c => c.value);
            trigger.textContent = checked.length > 0 ? checked.join(', ') : 'Select PM...';
            trigger.dataset.value = checked.join(', ');
            save(r.rowIndex, checked.join(', '));
        };

        label.appendChild(chk);
        label.appendChild(document.createTextNode(p.name));
        optsDiv.appendChild(label);
    });
    // Initial value
    trigger.dataset.value = currentPMs.join(', ');

    pmWrapper.appendChild(trigger);
    pmWrapper.appendChild(optsDiv);
    col1.appendChild(pmWrapper);

    // Col 2: PM Priority (Read Only)
    const col2 = document.createElement('div');
    col2.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);display:block;margin-bottom:4px;">PM PRIORITY</label>';
    const prioDiv = document.createElement('div');
    prioDiv.className = 'input-field';
    prioDiv.style.background = '#f8fafc';
    prioDiv.style.color = r.pm?.priority ? 'var(--text-main)' : 'var(--text-light)';
    prioDiv.textContent = r.pm?.priority || '—';
    col2.appendChild(prioDiv);

    // Col 3: PM Notes (Read Only)
    const col3 = document.createElement('div');
    col3.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);display:block;margin-bottom:4px;">PM NOTES</label>';
    const noteDiv = document.createElement('div');
    noteDiv.className = 'input-field';
    noteDiv.style.background = '#f8fafc';
    noteDiv.style.whiteSpace = 'nowrap';
    noteDiv.style.overflow = 'hidden';
    noteDiv.style.textOverflow = 'ellipsis';
    noteDiv.title = r.pm?.notes || '';
    noteDiv.style.color = r.pm?.notes ? 'var(--text-main)' : 'var(--text-light)';
    noteDiv.textContent = r.pm?.notes || '—';
    col3.appendChild(noteDiv);

    pmSection.appendChild(col1);
    pmSection.appendChild(col2);
    pmSection.appendChild(col3);
    body.appendChild(pmSection);

    // --- Team Section ---
    const tm = document.createElement('div');
    tm.className = 'team-section';
    const tList = document.createElement('div');
    tList.className = 'team-grid';

    [1, 2, 3].forEach(s => {
        const m = r.team.find(t => t.slot === s);
        const curName = m?.name;
        const d = document.createElement('div');
        d.className = 'team-card';
        if (!m?.name) d.classList.add('tm-empty');

        // Header (Designer Select)
        const header = document.createElement('div');
        header.style.marginBottom = '4px';

        const sel = document.createElement('select');
        sel.className = 'input-field';
        sel.style.padding = '4px';
        sel.style.fontSize = '12px';
        sel.style.height = 'auto';
        sel.dataset.slot = s;

        // Use shared categorical builder
        if (typeof populateCategorizedSelect === 'function') {
            populateCategorizedSelect(sel, curName);
        } else {
            // Fallback if missing
            const def = document.createElement('option');
            def.value = ''; def.textContent = 'Unassigned';
            sel.appendChild(def);
            PEOPLE_LIST.filter(p => (p.role || '').toUpperCase().includes('DESIGNER')).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name; opt.textContent = p.name;
                if (normalize(p.name) === normalize(curName)) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        // Listener for Exclusion & Save
        sel.addEventListener('change', () => {
            handleExclusion(tList, sel);
            save(r.rowIndex);
        });

        header.appendChild(sel);
        d.appendChild(header);

        // Info Body
        const info = document.createElement('div');
        info.className = 'tm-body';
        info.style.marginTop = '4px';

        if (m?.name) {
            const dateStr = m.dateDisplay ? m.dateDisplay.split(' ')[0] : '';
            info.innerHTML = `
                <div style="display:flex;justify-content:space-between;color:var(--text-muted);margin-bottom:2px;font-size:10px;">
                    <span style="font-weight:600;">${m.priority || '—'}</span>
                    <span>${dateStr}</span>
                </div>
                <div style="color:var(--text-main); font-size:11px; white-space:pre-wrap;">${m.notes || ''}</div>
             `;
        } else {
            info.textContent = '—';
        }
        d.appendChild(info);
        tList.appendChild(d);
    });

    // Initial Check for Exclusions
    if (typeof handleExclusion === 'function') {
        handleExclusion(tList, null);
    }

    tm.appendChild(tList);
    body.appendChild(tm);

    // --- Ops Notes ---
    const opsDiv = document.createElement('div');
    opsDiv.style.marginTop = '16px';
    opsDiv.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);display:block;margin-bottom:4px;">OPS NOTES</label>';
    const ta = document.createElement('textarea');
    ta.className = 'textarea-field';
    ta.id = `ops-note-${r.rowIndex}`;
    ta.rows = 2; // Smaller default
    ta.value = r.operational?.notes || '';
    ta.onchange = () => save(r.rowIndex);
    opsDiv.appendChild(ta);
    body.appendChild(opsDiv);

    card.appendChild(body);

    // 3. Footer
    const footer = document.createElement('div');
    footer.className = 'card-footer';
    footer.innerHTML = `
          <div style="display:flex;align-items:center;">
             <span class="sync-dot" id="dot-${r.rowIndex}"></span>
             <span id="opsmsg-${r.rowIndex}">${r.operational?.user ? 'Last upd by ' + r.operational.user : ''}</span>
          </div>
          <div>${r.operational?.dateDisplay || ''}</div>
      `;
    card.appendChild(footer);

    // Save Function Closure
    const save = (idx, pmOverride) => {
        const msg = document.getElementById(`opsmsg-${r.rowIndex}`);
        if (msg) msg.textContent = 'Saving...';
        const dot = document.getElementById(`dot-${r.rowIndex}`);
        if (dot) dot.className = 'sync-dot saving';

        const pmVal = pmOverride !== undefined ? pmOverride : (trigger ? trigger.dataset.value : '');

        const dSels = tList.querySelectorAll('select');
        const d1 = dSels[0].value;
        const d2 = dSels[1].value;
        const d3 = dSels[2].value;
        const opsNoteVal = ta.value;

        const body = {
            email: window.currentUser.email,
            mode: 'ops',
            payload: {
                rowIndex: r.rowIndex,
                pmName: pmVal,
                designer1: d1, designer2: d2, designer3: d3,
                operationalNotes: opsNoteVal
            }
        };

        const call = (typeof apiUpdateClient === 'function')
            ? apiUpdateClient(body)
            : fetch('/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(r => r.json());

        call.then(res => {
            if (msg) msg.textContent = 'Saved ' + (res && res.savedAtDisplay ? res.savedAtDisplay : '');
            if (dot) {
                dot.className = 'sync-dot saved';
                setTimeout(() => dot.className = 'sync-dot', 2000);
            }
        }).catch(err => {
            console.error(err);
            if (msg) msg.textContent = 'Error';
            if (dot) dot.className = 'sync-dot';
        });

        if (typeof enhancedSmartUpdateCard === 'function') {
            try {
                enhancedSmartUpdateCard(r.rowIndex, r.pm?.priority, r.pm?.priority, 'ops');
            } catch (e) { }
        }
    };


    // Close dropdowns on click outside (Global listener ensures this, but local listener helps too)
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-multiselect')) {
            optsDiv.classList.add('hidden');
        }
    });

    return card;
}

</script>