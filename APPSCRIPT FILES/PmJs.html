<script>
function ensureLegacyProjectShape_(p) {
  if (!p) return p;

  // Add legacy flat fields expected by some PM/Ops helpers (designer1/2/3, priority1/2/3, notes1/2/3)
  if (!('designer1' in p) && Array.isArray(p.team)) {
    const t = (slot) => (p.team.find(x => Number(x.slot) === Number(slot)) || {});
    const t1 = t(1), t2 = t(2), t3 = t(3);

    p.designer1 = t1.name || '';
    p.designer2 = t2.name || '';
    p.designer3 = t3.name || '';

    p.priority1 = t1.priority || '';
    p.priority2 = t2.priority || '';
    p.priority3 = t3.priority || '';

    p.notes1 = t1.notes || '';
    p.notes2 = t2.notes || '';
    p.notes3 = t3.notes || '';
  }

  return p;
}

function ensureLegacyProjects_(arr) {
  return (arr || []).map(ensureLegacyProjectShape_);
}

function apiProjectsRequest_(params) {
  // Apps Script mode
  if (window.google && google.script && google.script.run && typeof gasCall === 'function') {
    return gasCall('apiProjects', params);
  }

  // Local/Express fallback
  const q = new URLSearchParams();
  q.set('mode', params.mode || '');
  q.set('email', params.email || '');
  if (params.pmName !== undefined) q.set('pmName', params.pmName);
  if (params.includeUnassigned !== undefined) q.set('includeUnassigned', params.includeUnassigned);
  q.set('_t', Date.now());
  return fetch('/api/projects?' + q.toString()).then(r => r.json());
}

function loadPM(pm) {
  const urlParams = new URLSearchParams(window.location.search);
  const emailParam = urlParams.get('email') || ((window.currentUser && window.currentUser.email) || (typeof BOOT !== 'undefined' ? BOOT.email : '') || '');

  document.getElementById('liveText').textContent = 'Loading...';

  const inc = document.getElementById('includeUnassigned').checked;
  const pmQuery = pm || '';

  if (pmQuery !== 'Unassigned') {
    window.STICKY_UNASSIGNED = [];
  }

  apiProjectsRequest_({
    mode: 'pm',
    email: emailParam,
    pmName: pmQuery,          // local fallback compatibility
    pmQuery: pmQuery,         // GAS uses this
    includeUnassigned: inc
  })
    .then(res => {
      window.GLOBAL_META = res;
      console.log('PM Data Loaded:', res);
      if (res.designerCounts) console.log('Active Designer Counts:', res.designerCounts);

      const next = ensureLegacyProjects_(res.projects || []);

      if (window.Notif) {
        Notif.checkCompliance(next, 'pm');
      }
      PM_ROWS = next;

      const pmSel = document.getElementById('pmSelect');
      if (pmSel) {
        pmSel.innerHTML = '';

        const optMe = document.createElement('option');
        optMe.value = BOOT.name;
        optMe.textContent = 'My Projects';
        pmSel.appendChild(optMe);

        const optAll = document.createElement('option');
        optAll.value = '__ALL__';
        optAll.textContent = 'All Projects';
        pmSel.appendChild(optAll);

        (res.pmList || []).forEach(p => {
          if (p === '__ALL__' || normalize(p) === normalize(BOOT.name)) return;
          const o = document.createElement('option'); o.value = p; o.textContent = p || 'Unassigned';
          pmSel.appendChild(o);
        });

        if (!Array.from(pmSel.options).some(o => o.value === 'Unassigned')) {
          const oUn = document.createElement('option');
          oUn.value = 'Unassigned';
          oUn.textContent = 'Unassigned';
          pmSel.appendChild(oUn);
        }

        if (pm) pmSel.value = pm;
        else if (res.selectedPM) pmSel.value = res.selectedPM;
        else pmSel.value = BOOT.name;
      }

      if (res.people) PEOPLE_LIST = res.people;

      document.getElementById('liveText').textContent = 'Live';
      if (ACTIVE_TAB === 'pm') render();
    })
    .catch(err => {
      console.error("loadPM Failed", err);
      document.getElementById('liveText').textContent = 'Error';
    });
}


// --- PM Override Logic ---
function confirmPMOverride(pmName, projectPM) {
  // If undefined/auto-pass scenarios?
  // Current user is BOOT.name.
  // Project PM is projectPM.
  // If projectPM includes BOOT.name, return true.

  const myName = normalize(BOOT.name);
  const pms = (projectPM || '').split(',').map(s => normalize(s));

  if (pms.includes(myName)) return Promise.resolve(true); // Is my project

  // Else, show popup
  return new Promise(resolve => {
    let modal = document.getElementById('pmOverrideModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'pmOverrideModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;';
      document.body.appendChild(modal);
    }

    modal.innerHTML = `
      <div style="background:#1e293b; border:1px solid #334155; padding:24px; border-radius:12px; width:400px; max-width:90%; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">
         <h3 style="margin-top:0; color:#ef4444; font-size:18px;">⚠️ Not Assigned PM</h3>
         <p style="color:#cbd5e1; margin-bottom:20px;">You are not the assigned Project Manager for this project. <br><br>Do you want to proceed with changes?</p>
         <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button id="btnPMCancel" style="padding:8px 16px; border-radius:6px; border:1px solid #475569; background:transparent; color:#94a3b8; cursor:pointer;">Cancel</button>
            <button id="btnPMProceed" style="padding:8px 16px; border-radius:6px; border:none; background:#ef4444; color:white; cursor:pointer; font-weight:600;">Proceed</button>
         </div>
      </div>
     `;
    modal.style.display = 'flex';

    document.getElementById('btnPMProceed').onclick = () => { modal.style.display = 'none'; resolve(true); };
    document.getElementById('btnPMCancel').onclick = () => { modal.style.display = 'none'; render(); resolve(false); }; // Render to reset UI
  });
}

function buildPMCard(r) {
  const card = document.createElement('div');

  const pClass = getPrioClass(r.pm?.priority); // Still use PM priority for coloring? 
  // User: "get rid of the pm priority".
  // If PM priority is gone, maybe color by Max Designer Prio?
  // Or just white/default?
  // Let's use getNeighborBestRank style logic or just default.
  // I will use default for now to denote "Neutral" unless status is set.
  // Actually, status often drives color too.
  card.className = `card`;
  // If status is specific color, maybe apply border?

  card.id = `card-${r.rowIndex}`;

  // PM Access Check (Relaxed - can edit but warns)
  const canEdit = true;

  const top = document.createElement('div');
  top.className = 'card-top';
  const left = document.createElement('div');
  left.innerHTML = `<div class="project-title">${r.projectName || '(Untitled)'}</div><div class="project-meta">#${r.projectNumber} <span class="pm-tag">${r.pmName || 'Unassigned'}</span></div>`;
  top.appendChild(left);
  top.appendChild(buildStatusBadge(r.status));
  card.appendChild(top);

  const body = document.createElement('div');
  body.className = 'card-body';

  const form = document.createElement('div');
  form.className = 'form-grid';

  // PM Assign - Now Editable by ANY PM
  const g1 = document.createElement('div');
  g1.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);display:block;">PM ASSIGN</label>';

  // Custom PM selector to allow assignment
  // We can reuse populateCategorizedSelect if we adapt it or just a simple dropdown for PMs
  // loadPM populates #pmSelect. We can use values from there.
  // Or just a text input if list is huge? But dropdown is better.
  // Let's build a dropdown with PM list.
  const pmSel = document.createElement('select');
  pmSel.className = 'input-field';
  const pmList = BOOT.pmList || []; // Assuming we have it available or from loadPM closure? 
  // loadPM sets #pmSelect options. We can scrape? Or better, use global PEOPLE_LIST filtering for PMs.
  // Let's use PEOPLE_LIST.

  const nullOpt = document.createElement('option'); nullOpt.value = ''; nullOpt.textContent = 'Unassigned';
  pmSel.appendChild(nullOpt);

  PEOPLE_LIST.filter(p => (p.role || '').includes('PM')).forEach(p => {
    const o = document.createElement('option');
    o.value = p.name; o.textContent = p.name;
    if (normalize(r.pmName) === normalize(p.name)) o.selected = true;
    pmSel.appendChild(o);
  });
  // Also include current value if not in list
  if (r.pmName && !Array.from(pmSel.options).some(o => o.value === r.pmName)) {
    const o = document.createElement('option'); o.value = r.pmName; o.textContent = r.pmName; o.selected = true;
    pmSel.appendChild(o);
  }

  pmSel.addEventListener('change', () => savePM(r.rowIndex, card));
  g1.appendChild(pmSel);

  // REMOVED PM PRIORITY DROPDOWN (g2)

  form.appendChild(g1);
  // form.appendChild(g2); // Gone

  const g3 = document.createElement('div');
  g3.style.marginTop = '12px';
  g3.innerHTML = '<label style="font-size:11px;font-weight:700;color:var(--text-muted);">PM NOTES</label>';
  const ta = document.createElement('textarea');
  ta.className = 'textarea-field';
  ta.dataset.pmrow = r.rowIndex;
  ta.value = r.pm?.notes || '';
  g3.appendChild(ta);

  // Team Assign + Grid
  const g4 = document.createElement('div');
  g4.style.marginTop = '16px';
  g4.className = 'team-section';

  const tGrid = document.createElement('div');
  tGrid.className = 'team-grid';

  [1, 2, 3].forEach(slot => {
    const dCard = document.createElement('div');
    dCard.className = 'team-card';

    const member = r.team.find(t => t.slot === slot) || {};
    const curName = member.name;

    const header = document.createElement('div');
    header.className = 'tm-header';

    const dSel = document.createElement('select');
    dSel.className = 'input-field des-name-sel'; // Class marker
    dSel.style.fontSize = '12px';
    dSel.style.padding = '4px';
    dSel.style.marginBottom = '4px';
    dSel.style.fontWeight = '600';
    dSel.dataset.pmrow = r.rowIndex;
    dSel.dataset.desSlot = slot;

    populateCategorizedSelect(dSel, curName);

    // Feature: Explicit Selection & Validation
    // 1. Modify "Unassigned" (value="") to explicit value="Unassigned"
    const nullOpt = dSel.querySelector('option[value=""]');
    if (nullOpt) {
      nullOpt.value = 'Unassigned';
      nullOpt.textContent = 'Unassigned';
    }

    // 2. Add "Select..." placeholder if no value
    const placeOpt = document.createElement('option');
    placeOpt.value = '';
    placeOpt.textContent = 'Select Designer...';
    placeOpt.disabled = true;
    if (!curName) placeOpt.selected = true;
    dSel.insertBefore(placeOpt, dSel.firstChild);

    // 3. Validation Styling
    const validate = () => {
      if (dSel.value === '') dSel.classList.add('input-incomplete');
      else dSel.classList.remove('input-incomplete');
    };
    validate();
    dSel.addEventListener('change', validate);

    header.appendChild(dSel);

    // Feature: Smart Tooltip - Show Designer's Current Priorities
    const updateTooltip = () => {
      const name = dSel.value;
      if (!name || name === 'Unassigned' || !window.GLOBAL_META || !window.GLOBAL_META.projects) {
        dSel.title = "Select a designer to see their active load";
        return;
      }

      const normName = normalize(name);
      // Find all active projects for this designer
      const theirProjects = window.GLOBAL_META.projects.filter(p => {
        const status = normalize(p.status);
        if (['completed', 'abandoned', 'cancelled'].some(s => status.includes(s))) return false;
        return [1, 2, 3].some(slot => normalize(p[`designer${slot}`]) === normName);
      });

      const prioritized = [];
      const unprioritized = [];

      theirProjects.forEach(p => {
        let slot = [1, 2, 3].find(s => normalize(p[`designer${s}`]) === normName);
        if (!slot) return;
        const val = p[`priority${slot}`];
        const prio = parseInt(val);

        if (!isNaN(prio) && prio >= 1) {
          prioritized.push({ name: p.projectName, val: prio });
        } else {
          unprioritized.push({ name: p.projectName, val: '-' });
        }
      });

      prioritized.sort((a, b) => a.val - b.val);
      unprioritized.sort((a, b) => a.name.localeCompare(b.name));

      const lines = [];
      if (prioritized.length > 0) {
        lines.push(...prioritized.map(i => `${i.val}. ${i.name}`));
      }
      if (unprioritized.length > 0) {
        if (lines.length > 0) lines.push('----------');
        lines.push(...unprioritized.map(i => `- ${i.name}`));
      }

      if (lines.length === 0) {
        dSel.title = `${name}: No active projects.`;
      } else {
        dSel.title = `${name}'s Active Projects:\n${lines.join('\n')}`;
      }
    };
    // Initialize & Listen
    updateTooltip(); // Run once for valid initial
    dSel.addEventListener('change', updateTooltip);

    // Meta (Priority / Date)
    const meta = document.createElement('div');
    meta.className = 'tm-meta';

    // PM Editable Priority Dropdown
    // Only 1-10.
    const pSel = document.createElement('select');
    pSel.className = 'des-prio-sel'; // Class marker
    pSel.style.border = 'none';
    pSel.style.background = 'transparent';
    pSel.style.fontWeight = '700';
    pSel.style.cursor = 'pointer';
    pSel.style.fontSize = '12px';

    // Options
    // Dynamic Logic: Check designerCounts from Server
    // GLOBAL_META is set in loadPM. { designerCounts: { "name": count } }

    // Fallback: 1-10
    let maxOpts = 10;

    const _norm = (s) => String(s || '').toLowerCase().trim();
    if (curName && window.GLOBAL_META && window.GLOBAL_META.designerCounts) {
      const nName = _norm(curName);
      const count = window.GLOBAL_META.designerCounts[nName];

      console.log(`[PM DEBUG] Designer: "${curName}" -> "${nName}". Count via meta: ${count}`);

      if (typeof count === 'number') {
        if (count < 10) maxOpts = Math.max(count, 1);
      } else {
        console.warn(`[PM DEBUG] Count not found for ${nName}. Keys:`, Object.keys(window.GLOBAL_META.designerCounts));
      }
    }

    const opts = [];
    for (let i = 1; i <= maxOpts; i++) opts.push(String(i));

    const def = document.createElement('option'); def.value = ''; def.textContent = '-';
    pSel.appendChild(def);
    opts.forEach(o => {
      const op = document.createElement('option'); op.value = o; op.textContent = o;
      if (String(o) === String(member.priority || '')) op.selected = true;
      pSel.appendChild(op);
    });

    // If name is empty, disable priority editing?
    // User said "pm can directly change the priority for each designer".
    // Usually implies if a designer is assigned. If unassigned, priority doesn't make sense.
    // I'll disable if name is empty.
    // If name is empty or Unassigned, disable priority editing
    const n = String(curName || '').toLowerCase();
    if (!n || n === 'unassigned') pSel.disabled = true;

    // Date
    const dateStr = member.dateDisplay ? member.dateDisplay.split(' ')[0] : '';

    // Layout: Prio Select | Date
    meta.style.display = 'flex';
    meta.style.justifyContent = 'space-between';

    meta.appendChild(pSel);
    meta.appendChild(document.createTextNode(dateStr)); // Just text for date

    const noteDiv = document.createElement('div');
    noteDiv.className = 'tm-body';
    noteDiv.textContent = member.notes || '';
    if (!curName) {
      dCard.classList.add('tm-empty');
      noteDiv.textContent = 'Unassigned';
    }

    // Tooltip Handlers
    if (curName) {
      dCard.addEventListener('mouseenter', (e) => showDesignerTooltip(e, curName));
      dCard.addEventListener('mouseleave', hideDesignerTooltip);
    }

    dCard.appendChild(header);
    dCard.appendChild(meta);
    dCard.appendChild(noteDiv);
    tGrid.appendChild(dCard);
  });
  g4.appendChild(tGrid);

  body.appendChild(form);
  body.appendChild(g3);
  body.appendChild(g4);
  card.appendChild(body);

  const footer = document.createElement('div');
  footer.className = 'card-footer';
  footer.innerHTML = `<span id="pmmsg-${r.rowIndex}">${r.lastModified?.display ? 'Upd ' + r.lastModified.display : ''}</span>`;
  card.appendChild(footer);

  // Listeners
  const save = () => savePM(r.rowIndex, card);

  // Note save trigger
  ta.addEventListener('blur', save);

  // Team grid listeners
  tGrid.querySelectorAll('.des-name-sel').forEach(s => s.addEventListener('change', (e) => {
    handleExclusion(tGrid, e.target);

    // Auto-clear priority on designer change (User Request)
    const cardDiv = e.target.closest('.team-card');
    if (cardDiv) {
      const pSel = cardDiv.querySelector('.des-prio-sel');
      if (pSel) {
        pSel.value = '';
        // Disable if Unassigned
        const isUnassigned = !e.target.value || e.target.value === 'Unassigned';
        pSel.disabled = isUnassigned;
      }
    }

    save();
  }));

  tGrid.querySelectorAll('.des-prio-sel').forEach(s => s.addEventListener('change', (e) => {
    const newVal = e.target.value;
    const cardDiv = e.target.closest('.team-card');
    const nameSel = cardDiv.querySelector('.des-name-sel');
    const desName = nameSel.value;

    // If no designer, standard save (although disabled)
    if (!desName) { save(); return; }

    // Execute Shift Logic
    executeRemoteShift(r.rowIndex, 0, desName, newVal);
    // slot passed as 0/unused, executeRemoteShift uses name
  }));

  handleExclusion(tGrid, null);

  return card;
}

// --- Tooltip Logic ---
const DESIGNER_CACHE = {};

function showDesignerTooltip(e, email) {
  const person = PEOPLE_LIST.find(p => p.name === email);
  const query = person ? person.email : email;

  let tip = document.getElementById('designerTooltip');
  if (!tip) {
    tip = document.createElement('div');
    tip.id = 'designerTooltip';
    tip.className = 'designer-tooltip';
    document.body.appendChild(tip);
  }

  const rect = e.target.getBoundingClientRect();
  const scrollY = window.scrollY || document.documentElement.scrollTop;
  const scrollX = window.scrollX || document.documentElement.scrollLeft;

  tip.style.display = 'block';

  let left = rect.left + scrollX;
  const tipWidth = 300;
  if (left + tipWidth > window.innerWidth + scrollX - 20) {
    left = (window.innerWidth + scrollX - tipWidth - 20);
  }

  tip.style.top = (rect.bottom + scrollY + 5) + 'px';
  tip.style.left = left + 'px';
  tip.innerHTML = '<div class="spinner"></div> Loading...';

  if (DESIGNER_CACHE[query]) {
    renderTooltipContent(tip, DESIGNER_CACHE[query]);
  } else {
    apiProjectsRequest_({ mode: 'mine', email: query })
      .then(res => {
        const list = (res.projects || [])
          .map(p => ({
            priority: p.my?.priority || '',
            num: p.projectNumber,
            name: p.projectName
          }))
          .filter(x => x.priority && !isNaN(parseInt(x.priority, 10)));

        list.sort((a, b) => parseInt(a.priority, 10) - parseInt(b.priority, 10));
        DESIGNER_CACHE[query] = list;
        renderTooltipContent(tip, list);
      })
      .catch(() => {
        tip.innerHTML = 'Error loading priorities.';
      });
  }
}


function hideDesignerTooltip() {
  const tip = document.getElementById('designerTooltip');
  if (tip) tip.style.display = 'none';
}

function renderTooltipContent(el, list) {
  if (list.length === 0) {
    el.innerHTML = '<div style="padding:8px; color:#94a3b8;">No active priorities.</div>';
    return;
  }
  let html = '<div class="tooltip-header">Active Priorities</div><div class="tooltip-list">';
  list.forEach(x => {
    html += `
      <div class="tooltip-row">
        <span class="tt-prio">${x.priority}</span>
        <span class="tt-num">#${x.num}</span>
        <span class="tt-name">${x.name.substring(0, 25)}${x.name.length > 25 ? '...' : ''}</span>
      </div>
    `;
  });
  html += '</div>';
  el.innerHTML = html;
}

async function savePM(idx, card) {
  let row = PM_ROWS.find(r => r.rowIndex === idx);
  if (!row && window.STICKY_UNASSIGNED) {
    row = window.STICKY_UNASSIGNED.find(r => r.rowIndex === idx);
  }

  if (row) {
    const proceed = await confirmPMOverride(BOOT.name, row.pmName);
    if (!proceed) return;
  }

  const pmAssigned = card.querySelector('.form-grid select').value;
  const pmNote = card.querySelector('textarea').value;

  const dSels = card.querySelectorAll('.des-name-sel');
  const pSels = card.querySelectorAll('.des-prio-sel');

  const d1 = dSels[0].value, d2 = dSels[1].value, d3 = dSels[2].value;
  const p1 = pSels[0].value, p2 = pSels[1].value, p3 = pSels[2].value;

  const msg = document.getElementById(`pmmsg-${idx}`);
  if (msg) msg.textContent = 'Saving...';

  const pRow = PM_ROWS.find(r => r.rowIndex === idx);
  const sRow = (window.STICKY_UNASSIGNED || []).find(r => r.rowIndex === idx);
  const targets = [pRow, sRow].filter(x => x);
  const uniqueTargets = [...new Set(targets)];

  uniqueTargets.forEach(target => {
    if (target.pm) target.pm.notes = pmNote;
    target.pmName = pmAssigned;

    target.team = [1, 2, 3].map(slot => {
      const existing = (target.team || []).find(t => t.slot === slot) || {};
      const dVal = slot === 1 ? d1 : slot === 2 ? d2 : d3;
      const pVal = slot === 1 ? p1 : slot === 2 ? p2 : p3;
      return { slot, name: dVal, priority: pVal, notes: existing.notes || '', dateDisplay: existing.dateDisplay || '' };
    });

    ensureLegacyProjectShape_(target);
  });

  const pmSel = document.getElementById('pmSelect');
  if (pmSel && pmSel.value === 'Unassigned') {
    if (!window.STICKY_UNASSIGNED) window.STICKY_UNASSIGNED = [];
    if (!window.STICKY_UNASSIGNED.some(s => s.rowIndex === idx)) {
      if (row) window.STICKY_UNASSIGNED.push(row);
    }
  }

  const body = {
    email: window.currentUser.email,
    mode: 'pm',
    payload: {
      rowIndex: idx,
      pmPriority: '',
      pmNotes: pmNote,
      pmName: pmAssigned,
      designer1: d1, designer2: d2, designer3: d3,
      designer1Priority: p1,
      designer2Priority: p2,
      designer3Priority: p3
    }
  };

  const call = (typeof apiUpdateClient === 'function')
    ? apiUpdateClient(body)
    : fetch('/api/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(r => r.json());

  call.then(res => {
    if (msg) msg.textContent = 'Upd ' + (res && res.savedAtDisplay ? res.savedAtDisplay : '');
  }).catch(e => {
    console.error(e);
    if (msg) msg.textContent = 'Error';
  });
}


function saveCustomOrder(orderedRowIndexes) {
  const urlParams = new URLSearchParams(window.location.search);
  const emailParam = urlParams.get('email') || ((window.currentUser && window.currentUser.email) || (typeof BOOT !== 'undefined' ? BOOT.email : '') || '');

  const pmSelect = document.getElementById('pmSelect');
  const pmName = pmSelect ? pmSelect.value : BOOT.name;

  if (window.GLOBAL_META) {
    window.GLOBAL_META.customSortOrder = orderedRowIndexes;
  }

  const body = { email: emailParam, pmName, orderedRowIndexes };

  const call = (window.google && google.script && google.script.run && typeof gasCall === 'function')
    ? gasCall('apiSaveCustomOrder', body)
    : fetch('/api/custom-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(r => r.json());

  call.then(res => console.log('Custom order saved:', res))
      .catch(e => console.error('Failed to save custom order:', e));
}



// Make globally accessible for core.js drag-drop handlers
window.saveCustomOrder = saveCustomOrder;

async function executeRemoteShift(pmRowIndex, desSlot, desName, newPrio) {
  const person = PEOPLE_LIST.find(p => p.name === desName);
  const query = person ? person.email : desName;

  document.getElementById('liveText').textContent = 'Shifting...';

  try {
    const data = await apiProjectsRequest_({ mode: 'mine', email: query });
    let projects = ensureLegacyProjects_(data.projects || []);

    const targetProj = projects.find(p => String(p.rowIndex) === String(pmRowIndex));
    if (!targetProj) {
      console.error('Target project not found in designer list', pmRowIndex);
      return;
    }

    const updates = [];
    const targetPrioInt = parseInt(newPrio, 10);

    updates.push({
      rowIndex: targetProj.rowIndex,
      priority: String(newPrio),
      notes: targetProj.my?.notes || ''
    });

    let others = projects.filter(p => String(p.rowIndex) !== String(pmRowIndex));
    let bumpVal = targetPrioInt;

    while (true) {
      const conflict = others.find(p => parseInt(p.my?.priority, 10) === bumpVal);
      if (!conflict) break;

      const nextVal = bumpVal + 1;
      let newStr = String(nextVal);
      if (nextVal > 10) newStr = '';

      updates.push({
        rowIndex: conflict.rowIndex,
        priority: newStr,
        notes: conflict.my?.notes || ''
      });

      if (newStr === '') break;
      bumpVal = nextVal;
    }

    for (const u of updates) {
      const body = {
        email: query,
        mode: 'mine',
        payload: {
          rowIndex: u.rowIndex,
          priority: u.priority,
          notes: u.notes,
          realActorEmail: window.currentUser ? window.currentUser.email : null,
          skipNotifications: String(u.rowIndex) !== String(pmRowIndex)
        }
      };

      if (typeof apiUpdateClient === 'function') {
        await apiUpdateClient(body);
      } else {
        await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
      }
    }

    loadPM();
  } catch (e) {
    console.error('Remote Shift Failed', e);
    document.getElementById('liveText').textContent = 'Error';
  }
}


// --- Designer Centric View ---
let IS_DESIGNER_MODE = false;
let DESIGNER_SHOW_LIMIT = 3;

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btnDesignerMode');
  if (btn) {
    btn.addEventListener('click', () => {
      IS_DESIGNER_MODE = !IS_DESIGNER_MODE;

      // Polish: Button Styling
      if (IS_DESIGNER_MODE) {
        btn.textContent = 'Back to Project View';
        btn.style.background = '#ef4444'; // Red
        btn.style.color = 'white';
        btn.style.border = '1px solid #dc2626';
        document.body.style.backgroundColor = '#f8fafc'; // Light gray background for special view
      } else {
        btn.textContent = 'Designer View';
        btn.style.background = 'white';
        btn.style.color = '#0f172a';
        btn.style.border = '1px solid var(--border)';
        document.body.style.backgroundColor = ''; // Reset
      }

      let lim = document.getElementById('designerLimitInput');
      // Polish: Replace Input with Select Dropdown
      if (IS_DESIGNER_MODE && !lim) {
        lim = document.createElement('select');
        lim.id = 'designerLimitInput';

        const opts = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20];
        opts.forEach(n => {
          const o = document.createElement('option');
          o.value = n;
          o.textContent = `Show Top ${n}`;
          if (n === DESIGNER_SHOW_LIMIT) o.selected = true;
          lim.appendChild(o);
        });
        const oAll = document.createElement('option'); oAll.value = 999; oAll.textContent = 'Show All'; lim.appendChild(oAll);

        lim.style.cssText = 'height:30px; padding:0 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; margin-left:10px; cursor:pointer;';

        lim.addEventListener('change', (e) => {
          DESIGNER_SHOW_LIMIT = parseInt(e.target.value) || 3;
          render();
        });
        const filters = document.getElementById('pmFilters');
        if (filters) filters.appendChild(lim);
      } else if (lim) {
        lim.style.display = IS_DESIGNER_MODE ? 'block' : 'none';
      }

      render();
    });
  }
});

function renderDesignerBoard(grid, rows) {
  grid.innerHTML = '';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
  grid.style.gap = '20px';
  grid.style.alignItems = 'start'; // Align top

  // Fix: Handle role string (DB) or roles array (Boot/Mock)
  const getRoles = (p) => {
    if (Array.isArray(p.roles)) return p.roles.map(s => normalize(s));
    if (typeof p.role === 'string') return p.role.split(',').map(s => normalize(s));
    return [];
  };

  const designers = PEOPLE_LIST.filter(p => getRoles(p).includes('designer'));
  designers.sort((a, b) => a.name.localeCompare(b.name));

  designers.forEach(des => {
    const myProjects = rows.filter(r => (r.team || []).some(t => normalize(t.name) === normalize(des.name)));

    myProjects.sort((a, b) => {
      const getP = (p) => {
        const t = (p.team || []).find(tm => normalize(tm.name) === normalize(des.name));
        if (!t) return 999;
        const n = parseInt(t.priority, 10);
        return isNaN(n) ? 999 : n;
      };
      const pa = getP(a);
      const pb = getP(b);
      if (pa !== pb) return pa - pb;
      return (parseFloat(b.projectNumber) || 0) - (parseFloat(a.projectNumber) || 0);
    });

    if (myProjects.length === 0) return;

    const col = document.createElement('div');
    col.className = 'designer-board-card';
    col.style.cssText = 'background:white; border:1px solid #e2e8f0; border-radius:12px; padding:16px; display:flex; flex-direction:column;';

    const head = document.createElement('div');
    head.style.cssText = 'border-bottom:1px solid #f1f5f9; padding-bottom:12px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;';
    head.innerHTML = `<div style="font-weight:700; color:#0f172a;">${des.name}</div><div style="font-size:11px; color:#94a3b8;">${myProjects.length} Proj</div>`;
    col.appendChild(head);

    const list = document.createElement('div');
    list.style.cssText = 'display:flex; flex-direction:column; gap:8px;';

    const visible = myProjects.slice(0, DESIGNER_SHOW_LIMIT);

    visible.forEach(p => {
      const item = document.createElement('div');
      item.style.cssText = 'background:#f8fafc; border:1px solid #f1f5f9; border-radius:6px; padding:10px; font-size:12px;';

      const t = (p.team || []).find(tm => normalize(tm.name) === normalize(des.name));
      const prio = t ? t.priority : '';

      let prioHtml = prio ? `<span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-weight:700; margin-right:6px;">${prio}</span>` : `<span style="background:#e2e8f0; color:#64748b; padding:2px 6px; border-radius:4px; font-weight:700; margin-right:6px;">-</span>`;

      item.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:4px; pointer-events:none;">
             ${prioHtml}
             <span style="color:#94a3b8; font-family:monospace;">#${p.projectNumber}</span>
          </div>
          <div style="font-weight:600; color:#334155; margin-bottom:4px; line-height:1.3; pointer-events:none;">${p.projectName}</div>
          <div style="font-size:11px; color:#64748b; pointer-events:none;">${p.status}</div>
        `;

      // DnD Logic
      item.draggable = true;
      item.style.cursor = 'grab';

      // Find Slot (1,2,3)
      const getSlot = (proj, name) => {
        if (normalize(proj.designer1) === normalize(name)) return 1;
        if (normalize(proj.designer2) === normalize(name)) return 2;
        if (normalize(proj.designer3) === normalize(name)) return 3;
        return 1; // fallback
      };
      const mySlot = getSlot(p, des.name);

      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          rowIndex: p.rowIndex,
          designer: des.name,
          slot: mySlot,
          currentPrio: prio
        }));
        item.style.opacity = '0.5';
      });

      item.addEventListener('dragend', () => {
        item.style.opacity = '1';
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      });

      item.addEventListener('dragover', (e) => {
        e.preventDefault(); // Allow drop
        item.style.border = '2px dashed #3b82f6';
        item.classList.add('drag-over');
      });

      item.addEventListener('dragleave', () => {
        item.style.border = '1px solid #f1f5f9';
        item.classList.remove('drag-over');
      });

      item.addEventListener('drop', (e) => {
        e.preventDefault();
        item.style.border = '1px solid #f1f5f9';
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));

        // Logic: Dragged Project (data.rowIndex) -> Target Project (p.rowIndex/prio)
        // We are dropping ONTO 'p' (the target).
        // Constraint: Must be same designer column for simple "reorder".
        if (normalize(data.designer) !== normalize(des.name)) {
          alert("Please move projects within the same designer's list only.");
          return;
        }

        if (String(data.rowIndex) === String(p.rowIndex)) return; // Dropped on self

        // Target Priority
        // If I drop on Priority 3, I want to TAKE Priority 3.
        const targetPrio = prio;
        if (!targetPrio || targetPrio === '-' || targetPrio === '') {
          // If dropping on unranked item, maybe nothing happens or prompt?
          // Or assign lowest priority?
          // Let's assume we can only bump ranked items effectively or set to specific number.
          // If target is unranked, we can't really "Insert before unranked".
          alert("Please drop onto a ranked project to reorder.");
          return;
        }

        // Call Shift Logic
        // This will set dragged project to targetPrio. Old targetPrio gets bumped down.
        executeRemoteShift(data.rowIndex, data.slot, data.designer, targetPrio);
      });

      list.appendChild(item);
    });

    if (myProjects.length > DESIGNER_SHOW_LIMIT) {
      const more = document.createElement('div');
      more.style.cssText = 'text-align:center; font-size:11px; color:#94a3b8; padding-top:8px; font-style:italic;';
      more.textContent = `+ ${myProjects.length - DESIGNER_SHOW_LIMIT} more`;
      list.appendChild(more);
    }

    col.appendChild(list);
    grid.appendChild(col);
  });

  if (grid.children.length === 0) {
    grid.innerHTML = '<div style="padding:20px; color:#f59e0b;">Designers found (' + designers.length + '), but no projects matched their teamName.</div>';
  }
}

// Mutual Exclusion Logic for Designer Selections
// Exception: "Unassigned" can be selected multiple times
function handleExclusion(grid, changed) {
  const selects = Array.from(grid.querySelectorAll('.des-name-sel'));
  // Gather all selected values EXCEPT 'Unassigned'
  const values = selects.map(s => s.value).filter(v => v && v !== 'Unassigned');

  selects.forEach(sel => {
    Array.from(sel.options).forEach(opt => {
      // Always enable empty (placeholder) and Unassigned
      if (!opt.value || opt.value === 'Unassigned') {
        opt.disabled = false;
        return;
      }

      // If value is taken by another select, disable it
      if (values.includes(opt.value) && opt.value !== sel.value) {
        opt.disabled = true;
      } else {
        opt.disabled = false;
      }
    });
  });
}

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
  const pmSel = document.getElementById('pmSelect');
  if (pmSel) {
    pmSel.addEventListener('change', (e) => {
      loadPM(e.target.value);
    });
  }
});
</script>