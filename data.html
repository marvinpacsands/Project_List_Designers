<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Database Editor</title>
    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            background: #3b82f6;
            border: none;
            color: white;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.9;
        }

        button.save {
            background: #10b981;
        }

        button.add {
            background: #6366f1;
        }

        #example-table {
            height: 85vh;
            width: 100%;
            font-size: 13px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="controls">
        <button class="save" onclick="saveData()">Save Changes</button>
        <button class="add" onclick="addRow()">Add Project</button>
        <div id="status" style="margin-top: 8px; color: #ccc;">Loading...</div>
    </div>
    <div id="example-table"></div>
    <div id="toast" class="toast">Saved Successfully!</div>

    <!-- Tabulator JS -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script>
        let table;
        let fullDbState = {}; // Store non-project data to preserve it

        // Load data on init
        fetch('/api/raw-data')
            .then(res => res.json())
            .then(data => {
                fullDbState = data;
                initTable(data.projects || []);
                document.getElementById('status').innerText = `Loaded ${data.projects?.length} projects.`;
            })
            .catch(err => {
                document.getElementById('status').innerText = 'Error loading data: ' + err;
            });

        function initTable(data) {
            table = new Tabulator("#example-table", {
                data: data,
                layout: "fitData",
                height: "100%",
                movableColumns: true,
                history: true, // Enable Undo/Redo
                columns: [
                    { title: "ID", field: "id", width: 50, editor: "input" },
                    { title: "Project #", field: "projectNumber", editor: "input", frozen: true },
                    { title: "Project Name", field: "projectName", width: 250, editor: "input", frozen: true },
                    { title: "Status", field: "status", width: 200, editor: "input" },

                    // PM Section
                    { title: "PM", field: "pm", editor: "input" },
                    { title: "PM Prio", field: "pmPriority", editor: "input" },
                    { title: "PM Notes", field: "pmNotes", editor: "input" },

                    // Ops Section
                    { title: "Ops", field: "operational", editor: "input" },
                    { title: "Ops Notes", field: "operationalNotes", editor: "input" },

                    // Designer 1
                    { title: "Designer 1", field: "designer1", editor: "input" },
                    { title: "Prio 1", field: "priority1", editor: "input" },
                    { title: "Notes 1", field: "notes1", editor: "input" },

                    // Designer 2
                    { title: "Designer 2", field: "designer2", editor: "input" },
                    { title: "Prio 2", field: "priority2", editor: "input" },
                    { title: "Notes 2", field: "notes2", editor: "input" },

                    // Designer 3
                    { title: "Designer 3", field: "designer3", editor: "input" },
                    { title: "Prio 3", field: "priority3", editor: "input" },
                    { title: "Notes 3", field: "notes3", editor: "input" },

                    // Meta
                    { title: "Internal ID", field: "internalId", editor: "input" },
                    { title: "Row Index", field: "rowIndex", editor: "input" },
                    { title: "Created", field: "createdDate", editor: "input" },
                    { title: "Modified", field: "lastModified", formatter: "json" }, // Show object as JSON string since it's complex
                ],
            });

            // Auto add other columns discovered in data
            const allKeys = new Set();
            data.forEach(row => Object.keys(row).forEach(k => allKeys.add(k)));

            // If new columns exist that aren't defined, add them
            // Tabulator handles autoColumns too, but manual gives control.
        }

        function addRow() {
            table.addRow({
                id: Date.now(),
                projectName: "New Project",
                status: "Pending",
                createdDate: new Date().toISOString()
            }, true); // Add to top
        }

        function saveData() {
            const projects = table.getData();
            const payload = {
                ...fullDbState,
                projects: projects
            };

            fetch('/api/raw-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(res => {
                    if (res.success) {
                        showToast();
                        document.getElementById('status').innerText = `Saved ${res.count} projects.`;
                    } else {
                        alert('Save Failed: ' + res.error);
                    }
                })
                .catch(err => alert('Network Error: ' + err));
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
    </script>
</body>

</html>